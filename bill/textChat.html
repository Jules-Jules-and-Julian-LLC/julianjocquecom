<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>text chat waiting room</title>
    <style>
        body {
            color: #ff7648;
            background-color: #0f1f35;
            line-height: 1.5;
            font-family: monospace;
            margin: 20px;
            max-width: 700px;
        }
        a { color: #ff9970; }
        b { color: #ffaa80; }

        #consentPage h3 { margin-bottom: 4px; }

        .tech-section {
            color: #cc9080;
            margin: 12px 0;
        }
        .tech-section ol {
            margin: 6px 0 6px 20px;
            padding: 0;
        }
        .tech-section li {
            margin-bottom: 6px;
        }

        .join-section {
            margin-top: 24px;
            padding: 16px;
            border: 1px solid #ff764844;
            border-radius: 6px;
        }
        .join-section label {
            display: block;
            margin-bottom: 6px;
        }
        #nameInput {
            padding: 8px;
            background: #1a2a3f;
            border: 1px solid #ff764855;
            color: #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            width: 200px;
        }
        #joinBtn {
            padding: 8px 20px;
            background: #ff7648;
            color: #0f1f35;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: monospace;
            font-weight: bold;
            font-size: 14px;
            margin-left: 10px;
        }
        #joinBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* --- Chat UI (hidden until join) --- */
        #chatPage { display: none; }

        .status-bar {
            display: flex;
            gap: 24px;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        .dot-yellow {
            background: #e6c300;
            animation: pulse 1.5s ease-in-out infinite;
        }
        .dot-green { background: #2ecc40; }
        .dot-red { background: #e74c3c; }
        .dot-gray { background: #666; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        #messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ff764833;
            border-radius: 4px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 8px;
        }

        .msg {
            max-width: 70%;
            padding: 6px 10px;
            border-radius: 6px;
            word-wrap: break-word;
            font-size: 14px;
        }
        .msg-self {
            align-self: flex-end;
            background: #1a3a5c;
            color: #ddd;
        }
        .msg-peer {
            align-self: flex-start;
            background: #2a1a0a;
            color: #ddd;
        }
        .msg-system {
            align-self: center;
            color: #888;
            font-style: italic;
            font-size: 12px;
        }
        .msg-name {
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 2px;
            color: #ff7648;
        }
        .msg-peer .msg-name {
            color: #cc9070;
        }
        .msg-time {
            font-size: 10px;
            color: #666;
            margin-top: 2px;
        }

        #chatForm {
            display: flex;
            gap: 8px;
        }
        #chatInput {
            flex: 1;
            padding: 8px;
            background: #1a2a3f;
            border: 1px solid #ff764855;
            color: #ddd;
            border-radius: 4px;
            font-family: monospace;
        }
        #chatInput:disabled {
            opacity: 0.5;
        }
        #sendBtn {
            padding: 8px 16px;
            background: #ff7648;
            color: #0f1f35;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: monospace;
            font-weight: bold;
        }
        #sendBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* --- Connection log --- */
        #connLog {
            margin-top: 20px;
            border: 1px solid #ff764822;
            border-radius: 4px;
            padding: 8px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 11px;
            line-height: 1.4;
            color: #667;
        }
        #connLog b { color: #889; }
        .log-entry { margin-bottom: 2px; }
        .log-ws { color: #6a9fb5; }
        .log-rtc { color: #8a6fb5; }
        .log-ice { color: #6ab585; }
        .log-dc { color: #b5a56a; }
        .log-err { color: #b56a6a; }
        .log-label { font-weight: bold; }
    </style>
</head>
<body>

<script>
    // Cookie gate
    (function() {
        var match = document.cookie.match(/(?:^|; )billSolved=([^;]*)/);
        if (!match || match[1] !== '1') {
            window.location.href = './textChallenge.html';
        }
    })();
</script>

<!-- Connection log function — must exist before monkey-patches fire -->
<script>
    window._connLog = function(cls, label, detail) {
        var el = document.getElementById('connLog');
        if (!el) return;
        var entry = document.createElement('div');
        entry.className = 'log-entry';
        var t = new Date();
        var ts = t.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
        entry.innerHTML = '<span style="color:#555">' + ts + '</span> '
            + '<span class="' + cls + ' log-label">' + label + '</span> '
            + '<span class="' + cls + '">' + detail + '</span>';
        el.appendChild(entry);
        el.scrollTop = el.scrollHeight;
    };
</script>

<!-- Monkey-patch WebSocket and RTCPeerConnection BEFORE Trystero loads -->
<script>
    (function() {
        // --- WebSocket ---
        var OrigWS = window.WebSocket;
        window.WebSocket = function(url, protocols) {
            var ws = protocols ? new OrigWS(url, protocols) : new OrigWS(url);
            window._connLog('log-ws', 'WebSocket', 'connecting to ' + url);
            ws.addEventListener('open', function() {
                window._connLog('log-ws', 'WebSocket', 'opened ' + url);
            });
            ws.addEventListener('close', function(e) {
                window._connLog('log-ws', 'WebSocket', 'closed ' + url + ' (code ' + e.code + ')');
            });
            ws.addEventListener('error', function() {
                window._connLog('log-err', 'WebSocket', 'error on ' + url);
            });
            return ws;
        };
        window.WebSocket.prototype = OrigWS.prototype;
        window.WebSocket.CONNECTING = OrigWS.CONNECTING;
        window.WebSocket.OPEN = OrigWS.OPEN;
        window.WebSocket.CLOSING = OrigWS.CLOSING;
        window.WebSocket.CLOSED = OrigWS.CLOSED;

        // --- RTCPeerConnection ---
        var OrigRTC = window.RTCPeerConnection;
        var origProto = OrigRTC.prototype;
        window.RTCPeerConnection = function(config) {
            var pc = new OrigRTC(config);
            var servers = (config && config.iceServers || []).map(function(s) {
                return Array.isArray(s.urls) ? s.urls.join(', ') : s.urls;
            }).join('; ');
            window._connLog('log-rtc', 'RTCPeerConnection', 'created — interactive connectivity servers: ' + (servers || 'none'));

            pc.addEventListener('iceconnectionstatechange', function() {
                window._connLog('log-ice', 'connectivity', 'state → ' + pc.iceConnectionState);
            });
            pc.addEventListener('icegatheringstatechange', function() {
                window._connLog('log-ice', 'connectivity', 'gathering → ' + pc.iceGatheringState);
            });
            pc.addEventListener('connectionstatechange', function() {
                window._connLog('log-rtc', 'RTCPeerConnection', 'state → ' + pc.connectionState);
            });
            pc.addEventListener('datachannel', function(e) {
                window._connLog('log-dc', 'DataChannel', 'received: "' + e.channel.label + '"');
            });

            // Wrap createDataChannel to log outgoing channels
            var origCreateDC = pc.createDataChannel.bind(pc);
            pc.createDataChannel = function(label, opts) {
                window._connLog('log-dc', 'DataChannel', 'created: "' + label + '"');
                return origCreateDC(label, opts);
            };

            return pc;
        };
        window.RTCPeerConnection.prototype = origProto;
    })();
</script>

<!-- ========== CONSENT PAGE ========== -->
<div id="consentPage">
    <h3>Julian's sole attention waiting room</h3>

    <p>As before this page respects your privacy and consent above almost all else. I know I'm scary, I'm doing what I can to not be.</p>

    <div class="tech-section">
        <b>techblology</b>
        <p>This is as close to a you and me and we're gonna get online, I think it's clear I don't mind a corporeal meetup but it also sounds like that's more of a 2/15 kind of happening</p>
        <ul>
            <li>This uses a relay on <b>my private domain writeshite.com</b> everything is encrypyed on top, but worst case, it's on my own server (hosted admittedly on Digital Ocean (and it has logs (but not the chat messages, that's actually impossible (on the server/wire)))</li>
            <li>The worst part of the ""stack"" is the <b>Google STUN server</b> basically, the internet is a thorny, angry place, and people trust Google, so this lets us punch from IP to IP without running into problems between. It doesn't see the messages and is again encrypted. </li>
        </ul>
        <p>These are needed for us to shake hands, pass notes from hand to hand like a crisp fresh 20 dolla bill, then they're gone, and it's just us, on encrypted WebRTC chat. </p>

        <p>I commented out some AI crap that explains this in detail:</p>
        <!--
        <b>No third parties can read anything</b>
        <p>Even though the relay and STUN are involved briefly, they never see anything useful. Three layers of encryption make sure of that:</p>
        <ol>
            <li><b>Signaling encryption</b> &mdash; The WebRTC handshake (which contains IP addresses) is encrypted before it touches the relay. The password is derived from the argon2id hash you just cracked. Even Julian's own relay cannot read the signaling data or extract IPs from it.</li>
            <li><b>WebRTC DTLS</b> &mdash; Standard transport encryption on the data channel. Automatic and always-on.</li>
            <li><b>AES-256-GCM (application layer)</b> &mdash; Every message is encrypted with the Web Crypto API using a key derived from the same argon2id hash. Each message gets a unique 12-byte random IV. Even if someone somehow intercepted the data channel, they'd need the hash output to read anything.</li>
        </ol>
        -->

        <b>One major minor note</b>
        <p>IP Addresses ARE exchanged, that's like, how you talk online. Use a VPN to hide yours, I can't be bothered but I like Mullvad, it works well</p>

        <p>I made it so the chat history sticks to the browser storage, not just session, so our chats will be there. If you're uncool with this, let me know and I'll clear my history and be on with it.</p>

        <p>Last thing is that it has a little thingamabob showing the connections and stuff at the bottom so you can know exactly what's up, you can validated in your console as well, but I thought it looked cool and made me feel better knowing what was going on.</p>
    </div>

    <div class="join-section">
        <div id="presenceSection">
            <b>Julian Cheeccckkkkk</b>
            <div style="margin-top: 8px; color: #888; font-size: 12px;">This pings the server (joins and leaves chat) to see if Julian (me, I'm Julian Davis Jocque), is present and lets ya know, just so ya know, ya know? I will see the connection attempt, sorry.</div>
            <button id="presenceBtn" style="margin-top: 10px; padding: 8px 20px; background: #ff7648; color: #0f1f35; border: none; border-radius: 4px; cursor: pointer; font-family: monospace; font-weight: bold; font-size: 14px;">Jules Check</button>
            <div id="presenceResult" style="margin-top: 10px; display: none;"></div>
        </div>

        <div id="joinSection" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid #ff764833;">
            <label for="nameInput"><b>Name?</b></label>
            <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 8px;">
                <input type="text" id="nameInput" placeholder="your name" maxlength="24" autocomplete="off" />
                <button id="joinBtn" disabled>Join</button>
            </div>
        </div>
    </div>
</div>

<!-- ========== CHAT PAGE (hidden until join) ========== -->
<div id="chatPage">
    <div class="status-bar">
        <div class="status-item">
            <span class="dot dot-yellow" id="connDot"></span>
            <span id="connLabel">Connecting to relays...</span>
        </div>
        <div class="status-item">
            <span class="dot dot-gray" id="peerDot"></span>
            <span id="peerLabel">Julian's out (to (not) food)</span>
        </div>
    </div>

    <div id="messages"></div>

    <form id="chatForm">
        <input type="text" id="chatInput" placeholder="waiting for Julian..." disabled autocomplete="off" />
        <button type="submit" id="sendBtn" disabled>Send</button>
    </form>

    <div style="margin-top: 16px; color: #556; font-size: 12px;"><b style="color:#778;">connection log</b> &mdash; every network connection this page makes</div>
    <div id="connLog"></div>
</div>

<script type="module">
    import { joinRoom } from 'https://esm.run/trystero/nostr';

    const HASH = 'a4f106ffa30e4ad3f3b575624953b7ce9310de3bf3a166cf7f6fb598626b4fb0c0cbf9f824cee431d8e7225a74b1e3fb772482d7f0c3c3d8433ca5e41b203566';
    const roomIdHex = HASH.slice(0, 64);
    const aesKeyHex = HASH.slice(64);

    // DOM refs
    const consentPage = document.getElementById('consentPage');
    const chatPage = document.getElementById('chatPage');
    const presenceBtn = document.getElementById('presenceBtn');
    const presenceResult = document.getElementById('presenceResult');
    const presenceSection = document.getElementById('presenceSection');
    const joinSection = document.getElementById('joinSection');
    const nameInput = document.getElementById('nameInput');
    const joinBtn = document.getElementById('joinBtn');
    const connDot = document.getElementById('connDot');
    const connLabel = document.getElementById('connLabel');
    const peerDot = document.getElementById('peerDot');
    const peerLabel = document.getElementById('peerLabel');
    const messagesEl = document.getElementById('messages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const chatForm = document.getElementById('chatForm');

    // State
    let myName = '';
    let peerName = null;
    let peerCount = 0;
    let sendChat = null;
    let sendIdent = null;
    let cryptoKey = null;

    // --- Presence check (one-shot) ---
    presenceBtn.addEventListener('click', async function() {
        presenceBtn.disabled = true;
        presenceBtn.textContent = 'Checking...';
        presenceBtn.style.opacity = '0.5';
        presenceResult.style.display = 'block';
        presenceResult.style.color = '#cc9080';
        presenceResult.textContent = 'Connecting to relay...';

        let found = false;
        let probeRoom;
        try {
            probeRoom = joinRoom(
                {
                    appId: 'julianjocquecom-bill',
                    password: aesKeyHex,
                    relayUrls: ['wss://writeshite.com/nostr'],
                    rtcConfig: {
                        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                    }
                },
                roomIdHex
            );
        } catch (err) {
            presenceResult.style.color = '#e74c3c';
            presenceResult.textContent = 'Wuh oh fail mail! ' + err.message;
            presenceBtn.textContent = 'Jules Check';
            presenceBtn.disabled = false;
            presenceBtn.style.opacity = '1';
            return;
        }

        probeRoom.onPeerJoin(function() {
            found = true;
        });

        // Wait a few seconds for peers to show up, then report and disconnect
        await new Promise(function(resolve) { setTimeout(resolve, 5000); });

        probeRoom.leave();

        if (found) {
            presenceResult.style.color = '#2ecc40';
            presenceResult.innerHTML = '<span class="dot dot-green" style="display:inline-block;vertical-align:middle;margin-right:6px;"></span>Julian is in the chat right now.';
        } else {
            presenceResult.style.color = '#888';
            presenceResult.innerHTML = '<span class="dot dot-gray" style="display:inline-block;vertical-align:middle;margin-right:6px;"></span>Julian is not in the chat right now.';
        }

        presenceBtn.textContent = 'Check again';
        presenceBtn.disabled = false;
        presenceBtn.style.opacity = '1';

        // Show the join section regardless of result
        joinSection.style.display = 'block';
        nameInput.focus();
    });

    // Enable join button only when name is entered
    nameInput.addEventListener('input', function() {
        joinBtn.disabled = nameInput.value.trim().length === 0;
    });

    // --- localStorage persistence ---
    const STORAGE_KEY = 'billChat_' + roomIdHex.slice(0, 16);

    function loadHistory() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (raw) return JSON.parse(raw);
        } catch {}
        return [];
    }

    function saveHistory(history) {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        } catch {}
    }

    let chatHistory = loadHistory();

    // --- AES-256-GCM ---
    async function initCryptoKey() {
        const keyBytes = new Uint8Array(32);
        for (let i = 0; i < 32; i++) {
            keyBytes[i] = parseInt(aesKeyHex.substr(i * 2, 2), 16);
        }
        cryptoKey = await crypto.subtle.importKey(
            'raw', keyBytes, { name: 'AES-GCM' }, false, ['encrypt', 'decrypt']
        );
    }

    async function encryptMessage(plaintext) {
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const encoded = new TextEncoder().encode(plaintext);
        const ciphertext = await crypto.subtle.encrypt(
            { name: 'AES-GCM', iv }, cryptoKey, encoded
        );
        const combined = new Uint8Array(iv.length + ciphertext.byteLength);
        combined.set(iv);
        combined.set(new Uint8Array(ciphertext), iv.length);
        return btoa(String.fromCharCode(...combined));
    }

    async function decryptMessage(base64) {
        const binary = atob(base64);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
        const iv = bytes.slice(0, 12);
        const ciphertext = bytes.slice(12);
        const decrypted = await crypto.subtle.decrypt(
            { name: 'AES-GCM', iv }, cryptoKey, ciphertext
        );
        return new TextDecoder().decode(decrypted);
    }

    // --- UI helpers ---
    function formatTime(ts) {
        const d = new Date(ts);
        return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function appendMessage(from, name, text, time, isSystem) {
        const wrapper = document.createElement('div');
        if (isSystem) {
            wrapper.className = 'msg msg-system';
            wrapper.textContent = text;
        } else {
            wrapper.className = 'msg ' + (from === 'self' ? 'msg-self' : 'msg-peer');
            if (name) {
                const nameEl = document.createElement('div');
                nameEl.className = 'msg-name';
                nameEl.textContent = name;
                wrapper.appendChild(nameEl);
            }
            const content = document.createElement('div');
            content.textContent = text;
            wrapper.appendChild(content);
            const timeEl = document.createElement('div');
            timeEl.className = 'msg-time';
            timeEl.textContent = formatTime(time);
            wrapper.appendChild(timeEl);
        }
        messagesEl.appendChild(wrapper);
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function updatePeerUI() {
        const isJulian = peerName && peerName.toLowerCase() === 'julian';
        if (peerCount > 0) {
            peerDot.className = 'dot dot-green';
            peerLabel.textContent = isJulian ? 'The Julian abides.' : (peerName || 'Someone') + ' is here.';
            chatInput.disabled = false;
            sendBtn.disabled = false;
            chatInput.placeholder = 'Type a message...';
        } else {
            peerDot.className = 'dot dot-gray';
            peerLabel.textContent = "Julian Out SRY.";
            chatInput.disabled = true;
            sendBtn.disabled = true;
            chatInput.placeholder = 'Woe is thee, no Julian to Julian...';
            peerName = null;
        }
    }

    // --- Julian-only alerts (Web Audio API) ---
    function isJulianUser() {
        return myName.toLowerCase() === 'julian';
    }

    function playJoinAlert() {
        const ctx = new AudioContext();
        // Three rapid harsh beeps
        [0, 0.25, 0.5].forEach(function(offset) {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(880, ctx.currentTime + offset);
            osc.frequency.setValueAtTime(1200, ctx.currentTime + offset + 0.06);
            osc.frequency.setValueAtTime(880, ctx.currentTime + offset + 0.12);
            gain.gain.setValueAtTime(0.4, ctx.currentTime + offset);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + offset + 0.18);
            osc.connect(gain).connect(ctx.destination);
            osc.start(ctx.currentTime + offset);
            osc.stop(ctx.currentTime + offset + 0.18);
        });
    }

    function playMessageSound() {
        const ctx = new AudioContext();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(660, ctx.currentTime);
        osc.frequency.setValueAtTime(880, ctx.currentTime + 0.08);
        gain.gain.setValueAtTime(0.25, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
        osc.connect(gain).connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + 0.15);
    }

    function sendDesktopNotification(title, body) {
        if (Notification.permission === 'granted') {
            new Notification(title, { body: body });
        }
    }

    // --- Join handler ---
    joinBtn.addEventListener('click', function() {
        myName = nameInput.value.trim();
        if (!myName) return;
        // Request notification permission for Julian
        if (myName.toLowerCase() === 'julian' && 'Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
        consentPage.style.display = 'none';
        chatPage.style.display = 'block';
        initChat();
    });

    nameInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && nameInput.value.trim().length > 0) {
            e.preventDefault();
            joinBtn.click();
        }
    });

    async function initChat() {
        await initCryptoKey();

        // Load history into UI
        chatHistory.forEach(function(entry) {
            appendMessage(entry.from, entry.name || null, entry.text, entry.time, false);
        });

        let room;
        try {
            room = joinRoom(
                {
                    appId: 'julianjocquecom-bill',
                    password: aesKeyHex,
                    relayUrls: [
                        'wss://writeshite.com/nostr'
                    ],
                    rtcConfig: {
                        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                    }
                },
                roomIdHex
            );
        } catch (err) {
            connDot.className = 'dot dot-red';
            connLabel.textContent = 'Connection error: ' + err.message;
            appendMessage(null, null, 'Failed to connect: ' + err.message, Date.now(), true);
            return;
        }

        connDot.className = 'dot dot-green';
        connLabel.textContent = 'Connected to relays.';

        // Data channels
        const [sendChatMsg, onChatMsg] = room.makeAction('chat');
        const [sendIdentMsg, onIdentMsg] = room.makeAction('ident');
        sendChat = sendChatMsg;
        sendIdent = sendIdentMsg;

        // Presence
        room.onPeerJoin(function(peerId) {
            peerCount++;
            sendIdent(myName);
            updatePeerUI();
            appendMessage(null, null, 'Someone joined.', Date.now(), true);
            if (isJulianUser()) {
                playJoinAlert();
                sendDesktopNotification('Someone joined the chat', 'A visitor is in the text chat waiting room.');
            }
        });

        room.onPeerLeave(function(peerId) {
            peerCount = Math.max(0, peerCount - 1);
            updatePeerUI();
            appendMessage(null, null, (peerName || 'Someone') + ' left.', Date.now(), true);
        });

        // Receive identity
        onIdentMsg(function(name, peerId) {
            peerName = name;
            updatePeerUI();
        });

        // Receive chat messages
        onChatMsg(async function(data, peerId) {
            try {
                const plaintext = await decryptMessage(data);
                const time = Date.now();
                appendMessage('peer', peerName, plaintext, time, false);
                chatHistory.push({ from: 'peer', name: peerName, text: plaintext, time });
                saveHistory(chatHistory);
                if (isJulianUser()) playMessageSound();
            } catch (err) {
                appendMessage(null, null, 'Failed to decrypt a message.', Date.now(), true);
            }
        });

        // Send chat messages
        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const text = chatInput.value.trim();
            if (!text || peerCount === 0) return;

            const time = Date.now();
            const encrypted = await encryptMessage(text);
            sendChat(encrypted);

            appendMessage('self', myName, text, time, false);
            chatHistory.push({ from: 'self', name: myName, text, time });
            saveHistory(chatHistory);
            chatInput.value = '';
        });

        chatInput.focus();
    }
</script>

</body>
</html>
